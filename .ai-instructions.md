# Instructions pour l'IA - Toys API

Ce fichier contient les instructions Ã  suivre pour tout ajout ou modification future de l'API.

---

## ğŸ—ï¸ Architecture actuelle

- **Framework**: Node.js 20 + Express
- **Anti-bot**: FlareSolverr (requis)
- **Cache**: En mÃ©moire (Map avec TTL) - pas de Redis
- **Image Docker**: `nimai24/toys_api:latest`
- **Port production**: 3000
- **Version actuelle**: 2.0.0
- **Chiffrement**: AES-256-GCM (optionnel, via API_ENCRYPTION_KEY)

### Architecture v2.0.0 (Refactoring majeur)

```
toys_api/
â”œâ”€â”€ index.js              # Point d'entrÃ©e Express
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ config.js         # Configuration centralisÃ©e + VERSION
â”‚   â”œâ”€â”€ providers/        # Logique mÃ©tier par source
â”‚   â”‚   â”œâ”€â”€ amazon.js     # Amazon (cache unifiÃ©)
â”‚   â”‚   â”œâ”€â”€ lego.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ index.js      # Exports centralisÃ©s
â”‚       â”œâ”€â”€ logger.js     # Winston logger
â”‚       â”œâ”€â”€ state.js      # Cache global, mÃ©triques
â”‚       â”œâ”€â”€ helpers.js    # Utilitaires (extractApiKey, etc.)
â”‚       â”œâ”€â”€ flaresolverr.js
â”‚       â”œâ”€â”€ asyncHandler.js  # Wrapper try/catch async
â”‚       â””â”€â”€ middleware.js    # ğŸ†• Middlewares de validation
â””â”€â”€ routes/               # Routes Express par domaine
    â”œâ”€â”€ amazon.js
    â”œâ”€â”€ books.js          # ğŸ”„ Middleware requireApiKey
    â”œâ”€â”€ rebrickable.js    # ğŸ”„ Middleware requireApiKey
    â”œâ”€â”€ videogames.js     # ğŸ”„ Middleware requireApiKey
    â”œâ”€â”€ media.js          # ğŸ”„ Middleware requireApiKey
    â””â”€â”€ ...
```

### Middlewares de validation (v2.0.0)

Nouveaux middlewares dans `lib/utils/middleware.js` :

```javascript
const { requireParam, requireApiKey } = require('./lib/utils');

// Validation de paramÃ¨tre requis
router.get("/search", requireParam('q'), asyncHandler(async (req, res) => {
  // req.query.q est garanti prÃ©sent
}));

// Validation clÃ© API
const auth = requireApiKey('RAWG', 'https://rawg.io/apidocs');
router.get("/search", auth, asyncHandler(async (req, res) => {
  // req.apiKey contient la clÃ© dÃ©chiffrÃ©e
}));

// CombinÃ© : paramÃ¨tre + clÃ© API
router.get("/search", requireParam('q'), requireApiKey('Source'), asyncHandler(...));
```

### Sources implÃ©mentÃ©es :
- LEGO (lego.com) - GraphQL API
- Mega Construx (shop.mattel.com) - API Searchspring
- Rebrickable (rebrickable.com) - API REST officielle (nÃ©cessite clÃ© API)
- Google Books (books.google.com) - API REST (nÃ©cessite clÃ© API)
- OpenLibrary (openlibrary.org) - API REST gratuite
- RAWG (rawg.io) - API jeux vidÃ©o (nÃ©cessite clÃ© API)
- IGDB (igdb.com) - API jeux vidÃ©o Twitch (nÃ©cessite client_id:client_secret)
- TVDB (thetvdb.com) - API TV/Films (nÃ©cessite clÃ© API)
- TMDB (themoviedb.org) - API Films/TV (nÃ©cessite clÃ© API)
- IMDB (imdbapi.dev) - API Films/TV (gratuite)
- Jikan (myanimelist.net) - API Anime/Manga (gratuite)
- Comic Vine (comicvine.gamespot.com) - API Comics (clÃ© incluse)
- MangaDex (mangadex.org) - API Manga (gratuite)
- Bedetheque (bedetheque.com) - Scraping HTML (BD franco-belge)
- JeuxVideo.com (jeuxvideo.com) - Scraping HTML (Jeux vidÃ©o FR)
- ConsoleVariations (consolevariations.com) - Scraping HTML (Consoles & Accessoires)
- Coleka (coleka.com) - Scraping HTML
- Lulu-Berlu (lulu-berlu.com) - Scraping HTML
- Transformerland (transformerland.com) - Scraping HTML
- Paninimania (paninimania.com) - Scraping HTML (FR uniquement)
- Barcode - Multi-APIs (UPC, EAN, ISBN)
- Music - Multi-APIs (MusicBrainz, Deezer, Discogs, iTunes)

---

## ğŸ” SystÃ¨me de chiffrement des clÃ©s API

Pour les sources nÃ©cessitant une clÃ© API (Rebrickable, RAWG, IGDB, etc.), un systÃ¨me de chiffrement AES-256-GCM est disponible.

### Configuration
Variable d'environnement : `API_ENCRYPTION_KEY`
- Si dÃ©finie : les clÃ©s API doivent Ãªtre chiffrÃ©es avec cette clÃ©
- Si non dÃ©finie : les clÃ©s API peuvent Ãªtre passÃ©es en clair (dÃ©conseillÃ© en production)

### Utilisation dans les routes (v2.0.0)

```javascript
const { requireApiKey, asyncHandler } = require('../lib/utils');

// Le middleware extrait et attache la clÃ© Ã  req.apiKey
const auth = requireApiKey('NomSource', 'https://lien-inscription.com');

router.get("/search", auth, asyncHandler(async (req, res) => {
  const apiKey = req.apiKey; // ClÃ© dÃ©jÃ  extraite et dÃ©chiffrÃ©e
  // ... utiliser apiKey
}));
```

---

## âœ… Optimisations appliquÃ©es (Ã  maintenir)

Toute nouvelle fonctionnalitÃ© doit inclure ces optimisations :

### 1. Cache en mÃ©moire
```javascript
// Au dÃ©but de la fonction
const cacheKey = `source:type:${param1}:${param2}`;
const cached = getCached(cacheKey);
if (cached) return cached;

// Avant le return
setCache(cacheKey, result);
return result;
```

### 2. MÃ©triques par source
```javascript
// Dans le endpoint
metrics.sources.nouvelle_source.requests++;

// En cas d'erreur
metrics.requests.errors++;
metrics.sources.nouvelle_source.errors++;
```

### 3. Headers Cache-Control
```javascript
// Dans le endpoint, avant res.json()
addCacheHeaders(res, 300);
```

### 4. ParamÃ¨tres FlareSolverr optimisÃ©s
```javascript
// Pour les sites sans protection forte
await fsrRequest("request.get", url, fsrSessionId, {
  waitInSeconds: 1  // RÃ©duit (dÃ©faut Ã©tait 2-5s)
}, 45000);  // Timeout rÃ©duit Ã  45s
```

### 5. Ajouter la source dans les mÃ©triques
Dans la section `metrics` au dÃ©but du fichier :
```javascript
const metrics = {
  // ...
  sources: {
    // ... sources existantes
    nouvelle_source: { requests: 0, errors: 0 }
  }
};
```

---

## ğŸ§ª ProcÃ©dure de test

### âš ï¸ IMPORTANT : Ne pas interfÃ©rer avec la production !

Le container `toys_api` tourne en production sur le port 3000.

### CrÃ©er un container de test :
```bash
# Build local
cd "/NAS/Data/Mes Images Docker/toys_api"
docker build -t toys_api_test .

# Lancer sur un port diffÃ©rent (ex: 3001)
docker run -d \
  --name toys_api_test \
  --network="host" \
  -e FSR_BASE="http://10.110.1.1:8191/v1" \
  -e PORT=3001 \
  toys_api_test

# Tester
curl "http://localhost:3001/health"
curl "http://localhost:3001/nouvelle_source/search?q=test"

# Voir les logs
docker logs -f toys_api_test
```

### Nettoyer aprÃ¨s les tests :
```bash
docker stop toys_api_test
docker rm toys_api_test
docker rmi toys_api_test
```

---

## ğŸ“¦ ProcÃ©dure de dÃ©ploiement

Une fois les tests validÃ©s :

### 1. Mettre Ã  jour le README.md
- Ajouter la documentation du nouvel endpoint (EN + FR)
- Ajouter les paramÃ¨tres dans les tableaux
- Ajouter les exemples de rÃ©ponse JSON

### 2. Mettre Ã  jour /version endpoint
Dans `index.js`, ajouter la nouvelle source dans :
```javascript
app.get("/version", (req, res) => {
  res.json({
    // ...
    features: [
      // Ajouter ici
    ],
    endpoints: {
      nouvelle_source: ["/nouvelle_source/search", "/nouvelle_source/item"],
      // ...
    }
  });
});
```

### 3. DÃ©ployer sur Docker Hub
```bash
cd "/NAS/Data/Mes Images Docker/toys_api"
./deploy.sh
```

### 4. Nettoyage local
```bash
docker rmi toys_api nimai24/toys_api:latest 2>/dev/null
docker image prune -f
```

### 5. Laisser l'utilisateur mettre Ã  jour via Portainer
> **NE PAS** redÃ©marrer le container de production.
> L'utilisateur le fera lui-mÃªme via Portainer.

---

## ğŸ”‘ Ajouter une source avec clÃ© API

Pour les sources nÃ©cessitant une authentification (comme Rebrickable, RAWG, IGDB) :

### 1. Utiliser le middleware requireApiKey (v2.0.0)
```javascript
const { requireApiKey, asyncHandler } = require('../lib/utils');

// CrÃ©er l'instance du middleware avec source et hint
const auth = requireApiKey('NomSource', 'https://lien-pour-obtenir-cle.com');

// Utiliser comme middleware de route
router.get("/nouvelle_source/search", auth, asyncHandler(async (req, res) => {
  const apiKey = req.apiKey; // ClÃ© dÃ©jÃ  extraite et validÃ©e
  
  // Utiliser apiKey pour les appels Ã  l'API externe
  const result = await callExternalApi(apiKey, req.query.q);
  res.json(result);
}));
```

### 2. Avantages du middleware vs ancien code
```javascript
// âŒ Ancien code (v1.x) - rÃ©pÃ©titif
router.get("/search", asyncHandler(async (req, res) => {
  const apiKey = extractApiKey(req);
  if (!apiKey) {
    return res.status(401).json({ 
      error: "ClÃ© API requise",
      hint: "..."
    });
  }
  // ... logique
}));

// âœ… Nouveau code (v2.0) - concis
const auth = requireApiKey('Source', 'url');
router.get("/search", auth, asyncHandler(async (req, res) => {
  // req.apiKey est garanti prÃ©sent et valide
}));
```

### 2. Ne JAMAIS loguer les clÃ©s API
```javascript
// âŒ Mauvais
console.log(`API Key: ${apiKey}`);

// âœ… Bon
console.log(`[Source] RequÃªte avec clÃ© API (prÃ©sente)`);
```

### 3. Documenter dans le README
- Mentionner que la source nÃ©cessite une clÃ© API
- Expliquer les deux mÃ©thodes d'authentification (chiffrÃ©e/clair)
- Fournir le lien pour obtenir une clÃ© API

---

## ğŸ“ Structure des fichiers

```
toys_api/
â”œâ”€â”€ index.js              # Point d'entrÃ©e Express
â”œâ”€â”€ package.json          # DÃ©pendances
â”œâ”€â”€ Dockerfile            # Image Docker
â”œâ”€â”€ deploy.sh             # Script de dÃ©ploiement Docker Hub
â”œâ”€â”€ docker-compose.yml    # Configuration Portainer
â”œâ”€â”€ README.md             # Documentation utilisateur
â”œâ”€â”€ .ai-instructions.md   # CE FICHIER - Instructions IA
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ config.js         # Configuration centralisÃ©e + VERSION
â”‚   â”œâ”€â”€ providers/        # Logique mÃ©tier par source
â”‚   â”‚   â”œâ”€â”€ amazon.js     # Amazon (cache unifiÃ©)
â”‚   â”‚   â”œâ”€â”€ lego.js
â”‚   â”‚   â”œâ”€â”€ rebrickable.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ index.js      # Exports centralisÃ©s
â”‚       â”œâ”€â”€ logger.js     # Winston logger
â”‚       â”œâ”€â”€ state.js      # Cache global, mÃ©triques
â”‚       â”œâ”€â”€ helpers.js    # Utilitaires (extractApiKey, etc.)
â”‚       â”œâ”€â”€ flaresolverr.js
â”‚       â”œâ”€â”€ asyncHandler.js  # Wrapper try/catch async
â”‚       â””â”€â”€ middleware.js    # Middlewares de validation
â””â”€â”€ routes/               # Routes Express par domaine
    â”œâ”€â”€ amazon.js
    â”œâ”€â”€ books.js
    â”œâ”€â”€ coleka.js
    â”œâ”€â”€ lego.js
    â”œâ”€â”€ media.js
    â”œâ”€â”€ music.js
    â”œâ”€â”€ rebrickable.js
    â”œâ”€â”€ videogames.js
    â””â”€â”€ ...
```

---

## ğŸ”§ Variables d'environnement

| Variable | DÃ©faut | Description |
|----------|--------|-------------|
| `PORT` | `3000` | Port de l'API |
| `FSR_URL` | `http://10.110.1.1:8191/v1` | URL FlareSolverr |
| `CACHE_TTL` | `300000` | TTL cache (5 min) |
| `CACHE_MAX_SIZE` | `100` | Max entrÃ©es cache |
| `MAX_RETRIES` | `3` | Tentatives max |
| `DEFAULT_LOCALE` | `fr-FR` | Locale par dÃ©faut |

---

## ğŸ“ Checklist nouveau endpoint

- [ ] Provider crÃ©Ã© dans `lib/providers/`
- [ ] Route crÃ©Ã©e dans `routes/`
- [ ] Utiliser `asyncHandler()` pour toutes les routes async
- [ ] Utiliser `requireParam('q')` pour les paramÃ¨tres requis
- [ ] Utiliser `requireApiKey('Source', 'url')` si clÃ© API requise
- [ ] Cache avec `getCached()`/`setCache()` 
- [ ] MÃ©triques ajoutÃ©es dans `state.js`
- [ ] Headers cache avec `addCacheHeaders(res, 300)`
- [ ] waitInSeconds optimisÃ© (1-2s si possible)
- [ ] Timeout rÃ©duit (45s si possible)
- [ ] Tests sur container `toys_api_test` port 3001
- [ ] README.md mis Ã  jour (EN + FR)
- [ ] /version endpoint mis Ã  jour dans `index.js`
- [ ] DÃ©ployÃ© avec `./deploy.sh`
- [ ] Images locales nettoyÃ©es
- [ ] Utilisateur notifiÃ© pour mise Ã  jour Portainer

---

## ğŸ“¦ Changelog v2.0.0

### NouveautÃ©s
- **Architecture modulaire** : Code refactorisÃ© en `lib/` (providers, utils) et `routes/`
- **Middlewares de validation** : `requireParam()`, `requireApiKey()` pour DRY
- **Cache unifiÃ©** : Amazon migrÃ© vers cache global avec TTL personnalisÃ©
- **asyncHandler** : AppliquÃ© Ã  toutes les routes pour gestion d'erreurs centralisÃ©e
- **Version centralisÃ©e** : Unique source de vÃ©ritÃ© dans `lib/config.js`

### AmÃ©liorations
- ~200 lignes de code dupliquÃ© supprimÃ©es
- Validation des paramÃ¨tres factorisÃ©e
- Meilleure sÃ©paration des responsabilitÃ©s
- Logs structurÃ©s avec Winston
