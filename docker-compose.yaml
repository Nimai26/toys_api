networks:
  reseau_principal:
    external: true
    name: ${docker_network:?error}

services:
  # ============================================
  # VPN Gluetun (Private Internet Access)
  # Protection: Kill switch + Proxy HTTP + FlareSolverr
  # ============================================
  gluetun-toys:
    image: qmcgaw/gluetun:latest
    container_name: gluetun-toys
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # Provider VPN
      - VPN_SERVICE_PROVIDER=private internet access
      - OPENVPN_USER=${PIA_USER}
      - OPENVPN_PASSWORD=${PIA_PASS}
      # R√©gion - France par d√©faut
      - SERVER_REGIONS=${TOY_API_VPN_REGION}
      # Param√®tres de connexion
      - VPN_TYPE=openvpn
      - OPENVPN_PROTOCOL=udp
      # ========== KILL SWITCH ==========
      - FIREWALL=on
      - FIREWALL_VPN_INPUT_PORTS=${TOY_API_GLUETUN_CONTROL_PORT}
      - FIREWALL_OUTBOUND_SUBNETS=10.110.1.0/24,172.16.0.0/12
      # ========== PROXY HTTP pour Puppeteer ==========
      - HTTPPROXY=on
      - HTTPPROXY_LOG=off
      # Health check
      - HEALTH_VPN_DURATION_INITIAL=30s
      - TZ=${TZ}
    ports:
      # Control server gluetun (pour rotation IP)
      - "${TOY_API_GLUETUN_CONTROL_PORT}:8000"
    volumes:
      - ${DOCKER_DATA}/toys_api/data/gluetun-toys:/gluetun
    networks:
      - reseau_principal
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # FlareSolverr via VPN (pour TOUS les providers)
  # Utilise le r√©seau gluetun = kill switch automatique
  # ============================================
  flaresolverr-vpn:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr-vpn
    # IMPORTANT: Utilise le r√©seau du container gluetun
    # = Tout le trafic passe par le VPN + Kill switch si VPN down
    network_mode: "service:gluetun-toys"
    environment:
      - LOG_LEVEL=${TOY_API_FSR_LOG_LEVEL}
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
      - TZ=${TZ}
      - BROWSER_TIMEOUT=${TOY_API_BROWSER_TIMEOUT}
    depends_on:
      gluetun-toys:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      # FlareSolverr expose /health sur le port 8191 via le r√©seau gluetun
      test: ["CMD", "curl", "-sf", "http://localhost:8191/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # VPN Health Monitor + Rotation IP automatique
  # - V√©rifie le VPN toutes les ${TOY_API_HEALTH_CHECK_VPN_INTERVAL} secondes
  # - Relance si probl√®me d√©tect√© (3 √©checs cons√©cutifs)
  # - Rotation IP toutes les 30 minutes
  # ============================================
  vpn-monitor:
    image: alpine:latest
    container_name: vpn-monitor
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache curl
        echo "üõ°Ô∏è VPN Monitor d√©marr√©"
        echo "   - Health check: toutes les ${TOY_API_HEALTH_CHECK_VPN_INTERVAL:-60}s"
        echo "   - Rotation IP: toutes les ${TOY_API_ROTATION_INTERVAL:-1800}s"
        
        ROTATION_INTERVAL=${TOY_API_ROTATION_INTERVAL}
        HEALTH_CHECK_INTERVAL=${TOY_API_HEALTH_CHECK_VPN_INTERVAL}
        MAX_FAILURES=${TOY_API_MAX_FAILURES}
        last_rotation=$$(date +%s)
        consecutive_failures=0
        
        while true; do
          sleep $$HEALTH_CHECK_INTERVAL
          now=$$(date +%s)
          
          # === HEALTH CHECK ===
          VPN_STATUS=$$(curl -sf http://gluetun-toys:8000/v1/openvpn/status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          VPN_IP=$$(curl -sf http://gluetun-toys:8000/v1/publicip/ip 2>/dev/null | grep -o '"public_ip":"[^"]*"' | cut -d'"' -f4)
          
          if [ "$$VPN_STATUS" != "running" ] || [ -z "$$VPN_IP" ]; then
            consecutive_failures=$$((consecutive_failures + 1))
            echo "[$(date)] ‚ö†Ô∏è VPN probl√®me d√©tect√© ($$consecutive_failures/$$MAX_FAILURES) - Status: $$VPN_STATUS, IP: $$VPN_IP"
            
            if [ $$consecutive_failures -ge $$MAX_FAILURES ]; then
              echo "[$(date)] üîÑ Red√©marrage VPN..."
              curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"stopped"}' > /dev/null 2>&1
              sleep 5
              curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"running"}' > /dev/null 2>&1
              sleep 20
              consecutive_failures=0
              
              # V√©rifier si √ßa a march√©
              NEW_STATUS=$$(curl -sf http://gluetun-toys:8000/v1/openvpn/status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              NEW_IP=$$(curl -sf http://gluetun-toys:8000/v1/publicip/ip 2>/dev/null | grep -o '"public_ip":"[^"]*"' | cut -d'"' -f4)
              if [ "$$NEW_STATUS" = "running" ] && [ -n "$$NEW_IP" ]; then
                echo "[$(date)] ‚úÖ VPN relanc√© avec succ√®s - IP: $$NEW_IP"
              else
                echo "[$(date)] ‚ùå √âchec relance VPN - Status: $$NEW_STATUS"
              fi
            fi
          else
            if [ $$consecutive_failures -gt 0 ]; then
              echo "[$(date)] ‚úÖ VPN r√©tabli - IP: $$VPN_IP"
            fi
            consecutive_failures=0
          fi
          
          # === ROTATION IP AUTOMATIQUE ===
          elapsed=$$((now - last_rotation))
          if [ $$elapsed -ge $$ROTATION_INTERVAL ]; then
            echo "[$(date)] üîÑ Rotation IP programm√©e..."
            OLD_IP=$$VPN_IP
            curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"stopped"}' > /dev/null 2>&1
            sleep 5
            curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"running"}' > /dev/null 2>&1
            sleep 15
            NEW_IP=$$(curl -sf http://gluetun-toys:8000/v1/publicip/ip 2>/dev/null | grep -o '"public_ip":"[^"]*"' | cut -d'"' -f4)
            echo "[$(date)] ‚úÖ IP chang√©e: $$OLD_IP -> $$NEW_IP"
            last_rotation=$$now
          fi
        done
    environment:
      - ROTATION_INTERVAL=${TOY_API_ROTATION_INTERVAL}
      - HEALTH_CHECK_INTERVAL=${TOY_API_HEALTH_CHECK_VPN_INTERVAL}
      - MAX_FAILURES=${TOY_API_MAX_FAILURES}
    networks:
      - reseau_principal
    depends_on:
      gluetun-toys:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      # V√©rifie que le script tourne en testant la connexion √† gluetun
      test: ["CMD", "curl", "-sf", "http://gluetun-toys:8000/v1/openvpn/status"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # Toys API v3.2.0 - Scraping via Puppeteer + VPN
  # Les cl√©s API (Rebrickable, TMDB, etc.) sont fournies
  # via header X-Encrypted-Key lors des appels
  # ============================================
  toys_api:
    image: nimai24/toys_api:latest
    container_name: toys_api
    restart: unless-stopped
    ports:
      - "${TOYS_API_PORT}:3000"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      # ========== TOUT PASSE PAR LE VPN ==========
      # FlareSolverr via VPN (pour tous les providers sauf Amazon)
      - FSR_URL=http://gluetun-toys:8191/v1
      # Proxy VPN pour Puppeteer (Amazon uniquement)
      - VPN_PROXY_URL=http://gluetun-toys:8888
      - PUPPETEER_USE_VPN=${TOY_API_PUPPETEER_USE_VPN}
      # Control Gluetun pour rotation IP
      - GLUETUN_CONTROL_URL=http://gluetun-toys:8000
      # Param√®tres API
      - PORT=${TOYS_API_PORT}
      - MAX_RETRIES=${TOY_API_MAX_RETRIES}
      - DEFAULT_LOCALE=${TOY_API_DEFAULT_LOCALE}
      - CACHE_TTL=${TOY_API_CACHE_TTL}
      - CACHE_MAX_SIZE=${TOY_API_CACHE_MAX_SIZE}
      - LOG_LEVEL=${TOY_API_LOG_LEVEL}
      # Traduction automatique (optionnel)
      - AUTO_TRAD_URL=${TOY_API_AUTO_TRAD_URL} 
      - API_ENCRYPTION_KEY=${TOY_API_API_ENCRYPTION_KEY}
      # ========== MONITORING & ALERTES EMAIL ==========
      - ENABLE_MONITORING=${TOY_API_ENABLE_MONITORING}
      - HEALTHCHECK_INTERVAL_HOURS=${TOY_API_HEALTHCHECK_PROVIDERS_INTERVAL_HOURS} #en heures
      # Configuration SMTP pour les alertes
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURITY=${SMTP_SECURITY}
      - SMTP_USERNAME=${TOY_API_SMTP_USERNAME}
      - SMTP_PASSWORD=${TOY_API_SMTP_PASSWORD}
      - SMTP_FROM=${TOY_API_SMTP_FROM}
      - SMTP_FROM_NAME=${TOY_API_SMTP_FROM_NAME}
      - EMAIL_DEST=${TOY_API_EMAIL_DEST}
      # Cl√©s API de test pour le monitoring (optionnel)
      - TEST_REBRICKABLE_KEY=${TOY_API_TEST_REBRICKABLE_KEY}
      - TEST_TMDB_KEY=${TOY_API_TEST_TMDB_KEY}
      - TEST_RAWG_KEY=${TOY_API_TEST_RAWG_KEY}
      - TEST_TVDB_KEY=${TOY_API_TEST_TVDB_KEY}
      - TEST_GOOGLEBOOKS_KEY=${TOY_API_TEST_GOOGLEBOOKS_KEY}
      - TEST_COMICVINE_KEY=${TOY_API_TEST_COMICVINE_KEY}
      - TEST_IGDB_CLIENT_ID=${TOY_API_TEST_IGDB_CLIENT_ID}
      - TEST_IGDB_CLIENT_SECRET=${TOY_API_TEST_IGDB_CLIENT_SECRET}
      - TEST_DISCOGS_KEY=${TOY_API_TEST_DISCOG_KEY}
      # ========== BASE DE DONN√âES (Cache PostgreSQL) ==========
      - TOY_API_DB_ENABLED=${TOY_API_DB_ENABLED:-true}
      - TOY_API_DB_HOST=toys_api_postgres
      - TOY_API_DB_PORT=5432
      - TOY_API_DB_NAME=${TOY_API_DB_NAME:-toys_api_cache}
      - TOY_API_DB_USER=${TOY_API_DB_USER:-toys_api}
      - TOY_API_DB_PASSWORD=${TOY_API_DB_PASSWORD:?error}
      - TOY_API_CACHE_MODE=${TOY_API_CACHE_MODE:-hybrid}     
    volumes:
      - ${DOCKER_DATA}/toys_api/data:/app/data
    networks:
      - reseau_principal
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      gluetun-toys:
        condition: service_healthy

  # ============================================
  # Snow Shelf API - Recherche par image
  # ============================================
  snow_shelf_api:
    image: nimai24/snow_shelf_api:latest
    container_name: snow_shelf_api
    restart: unless-stopped
    ports:
      - "${TOY_API_SNOWSHELF_API_PORT}:8088"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - TOYS_API_URL=http://toys_api:3000
      - ENABLE_CLIP=true
      - ENABLE_OCR=true
      - OMP_NUM_THREADS=4
      - MKL_NUM_THREADS=4
      - CLIP_THREADS=4
      - CACHE_TTL=300
    volumes:
      - ${DOCKER_DATA}/snow_shelf_api/logs:/app/logs
      - ${DOCKER_DATA}/snow_shelf_api/uploads:/app/uploads
      - ${DOCKER_DATA}/snow_shelf_api/tmp:/app/tmp
    networks:
      - reseau_principal
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      start_period: 90s
      retries: 3
    depends_on:
      - toys_api
  # ============================================
  # PostgreSQL - Base de donn√©es cache toys_api
  # Stockage persistant des donn√©es r√©cup√©r√©es
  # ============================================
  toys_api_postgres:
    image: postgres:16-alpine
    container_name: toys_api_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${TOY_API_DB_NAME:-toys_api_cache}
      - POSTGRES_USER=${TOY_API_DB_USER:-toys_api}
      - POSTGRES_PASSWORD=${TOY_API_DB_PASSWORD:?error}
      - TZ=${TZ}
    volumes:
      - ${DOCKER_DATA}/toys_api/postgres:/var/lib/postgresql/data
    networks:
      - reseau_principal
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TOY_API_DB_USER:-toys_api} -d ${TOY_API_DB_NAME:-toys_api_cache}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
