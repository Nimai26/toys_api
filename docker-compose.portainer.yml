# ============================================================================
# Toys API - Stack Portainer avec VPN
# ============================================================================
# 
# Stack complÃ¨te pour dÃ©ployer Toys API avec protection VPN intÃ©grÃ©e.
# Tous les providers (Amazon, Coleka, JVC, etc.) passent par le VPN.
#
# PRÃ‰REQUIS:
# - RÃ©seau Docker externe "swag" existant
# - Compte VPN PIA (Private Internet Access)
#
# VARIABLES D'ENVIRONNEMENT REQUISES:
# - PUID, PGID, TZ (systÃ¨me)
# - PIA_USER, PIA_PASS (credentials VPN)
# - Dockerap (chemin des donnÃ©es Docker, ex: /Docker_Data/)
#
# DÃ‰PLOIEMENT:
# 1. Copier ce fichier dans Portainer > Stacks > Add Stack
# 2. Configurer les variables d'environnement
# 3. DÃ©ployer
#
# PORTS EXPOSÃ‰S:
# - 3000: Toys API
# - 8193: Gluetun Control API (rotation IP, status VPN)
#
# ============================================================================

version: "3.9"

services:
  # ============================================
  # VPN Gluetun (Private Internet Access)
  # - Kill switch (bloque tout si VPN down)
  # - Proxy HTTP pour Puppeteer (:8888)
  # - HÃ©berge FlareSolverr (:8191)
  # ============================================
  gluetun-toys:
    image: qmcgaw/gluetun:latest
    container_name: gluetun-toys
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # === VPN Provider ===
      - VPN_SERVICE_PROVIDER=private internet access
      - OPENVPN_USER=${PIA_USER}
      - OPENVPN_PASSWORD=${PIA_PASS}
      - SERVER_REGIONS=${VPN_REGION:-France}
      - VPN_TYPE=openvpn
      - OPENVPN_PROTOCOL=udp
      # === Kill Switch ===
      - FIREWALL=on
      - FIREWALL_VPN_INPUT_PORTS=8191
      - FIREWALL_OUTBOUND_SUBNETS=${LOCAL_SUBNETS:-10.0.0.0/8,172.16.0.0/12,192.168.0.0/16}
      # === Proxy HTTP (pour Puppeteer) ===
      - HTTPPROXY=on
      - HTTPPROXY_LOG=off
      # === Health ===
      - HEALTH_VPN_DURATION_INITIAL=30s
      - TZ=${TZ:-Europe/Paris}
    ports:
      - "${GLUETUN_CONTROL_PORT:-8193}:8000"
    volumes:
      - ${Dockerap:-/docker/}gluetun-toys:/gluetun
    networks:
      - ${DOCKER_NETWORK:-swag}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # FlareSolverr via VPN
  # Bypass Cloudflare pour tous les providers
  # Utilise le rÃ©seau gluetun = protection VPN
  # ============================================
  flaresolverr-vpn:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr-vpn
    network_mode: "service:gluetun-toys"
    environment:
      - LOG_LEVEL=${FSR_LOG_LEVEL:-info}
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
      - TZ=${TZ:-Europe/Paris}
      - BROWSER_TIMEOUT=${FSR_TIMEOUT:-60000}
    depends_on:
      gluetun-toys:
        condition: service_healthy
    restart: unless-stopped

  # ============================================
  # VPN Monitor
  # - Health check toutes les 60s
  # - Auto-restart VPN si 3 Ã©checs consÃ©cutifs
  # - Rotation IP automatique toutes les 30min
  # ============================================
  vpn-monitor:
    image: alpine:latest
    container_name: vpn-monitor
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache curl
        echo "ðŸ›¡ï¸ VPN Monitor dÃ©marrÃ©"
        echo "   - Health check: toutes les 60s"
        echo "   - Rotation IP: toutes les ${ROTATION_MINUTES:-30}min"
        
        ROTATION_INTERVAL=${ROTATION_SECONDS:-1800}
        HEALTH_CHECK_INTERVAL=60
        MAX_FAILURES=3
        last_rotation=$$(date +%s)
        consecutive_failures=0
        
        while true; do
          sleep $$HEALTH_CHECK_INTERVAL
          now=$$(date +%s)
          
          # === HEALTH CHECK ===
          VPN_STATUS=$$(curl -sf http://gluetun-toys:8000/v1/openvpn/status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          VPN_IP=$$(curl -sf http://gluetun-toys:8000/v1/publicip/ip 2>/dev/null | grep -o '"public_ip":"[^"]*"' | cut -d'"' -f4)
          
          if [ "$$VPN_STATUS" != "running" ] || [ -z "$$VPN_IP" ]; then
            consecutive_failures=$$((consecutive_failures + 1))
            echo "[$(date)] âš ï¸ VPN problÃ¨me ($$consecutive_failures/$$MAX_FAILURES) - Status: $$VPN_STATUS"
            
            if [ $$consecutive_failures -ge $$MAX_FAILURES ]; then
              echo "[$(date)] ðŸ”„ RedÃ©marrage VPN..."
              curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"stopped"}' > /dev/null 2>&1
              sleep 5
              curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"running"}' > /dev/null 2>&1
              sleep 20
              consecutive_failures=0
              
              NEW_IP=$$(curl -sf http://gluetun-toys:8000/v1/publicip/ip 2>/dev/null | grep -o '"public_ip":"[^"]*"' | cut -d'"' -f4)
              [ -n "$$NEW_IP" ] && echo "[$(date)] âœ… VPN relancÃ© - IP: $$NEW_IP" || echo "[$(date)] âŒ Ã‰chec relance VPN"
            fi
          else
            [ $$consecutive_failures -gt 0 ] && echo "[$(date)] âœ… VPN OK - IP: $$VPN_IP"
            consecutive_failures=0
          fi
          
          # === ROTATION IP ===
          elapsed=$$((now - last_rotation))
          if [ $$elapsed -ge $$ROTATION_INTERVAL ]; then
            echo "[$(date)] ðŸ”„ Rotation IP..."
            OLD_IP=$$VPN_IP
            curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"stopped"}' > /dev/null 2>&1
            sleep 5
            curl -sf -X PUT http://gluetun-toys:8000/v1/openvpn/status -d '{"status":"running"}' > /dev/null 2>&1
            sleep 15
            NEW_IP=$$(curl -sf http://gluetun-toys:8000/v1/publicip/ip 2>/dev/null | grep -o '"public_ip":"[^"]*"' | cut -d'"' -f4)
            echo "[$(date)] âœ… IP: $$OLD_IP -> $$NEW_IP"
            last_rotation=$$now
          fi
        done
    networks:
      - ${DOCKER_NETWORK:-swag}
    depends_on:
      gluetun-toys:
        condition: service_healthy
    restart: unless-stopped

  # ============================================
  # Toys API
  # API de scraping multi-providers
  # Amazon: Puppeteer Stealth via proxy VPN
  # Autres: FlareSolverr via VPN
  # ============================================
  toys_api:
    image: nimai24/toys_api:latest
    container_name: toys_api
    restart: unless-stopped
    ports:
      - "${TOYS_API_PORT:-3000}:3000"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Paris}
      # === VPN Configuration ===
      - FSR_URL=http://gluetun-toys:8191/v1
      - VPN_PROXY_URL=http://gluetun-toys:8888
      - PUPPETEER_USE_VPN=true
      - GLUETUN_CONTROL_URL=http://gluetun-toys:8000
      # === API Configuration ===
      - PORT=3000
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - DEFAULT_LOCALE=${DEFAULT_LOCALE:-fr-FR}
      - CACHE_TTL=${CACHE_TTL:-300000}
      - CACHE_MAX_SIZE=${CACHE_MAX_SIZE:-100}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - ${Dockerap:-/docker/}toys_api/data:/app/data
    networks:
      - ${DOCKER_NETWORK:-swag}
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      gluetun-toys:
        condition: service_healthy

networks:
  swag:
    external: true
